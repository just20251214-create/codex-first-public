name: PDCA Loop

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  pdca:
    runs-on: ubuntu-latest

    steps:
      - name: Plan - checkout
        uses: actions/checkout@v4

      - name: Plan - setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Do - install runtime
        run: |
          python -m pip install --upgrade pip
          pip install jupyter nbconvert ipykernel

      - name: Do - execute notebook
        id: do_notebook
        continue-on-error: true
        run: |
          jupyter nbconvert --to notebook --execute 20260221/test.ipynb --output executed-test.ipynb

      - name: Check - build PDCA report
        if: always()
        run: |
          mkdir -p reports
          {
            echo "# PDCA Report"
            echo
            echo "- Workflow: ${GITHUB_WORKFLOW}"
            echo "- Run ID: ${GITHUB_RUN_ID}"
            echo "- Commit: ${GITHUB_SHA}"
            echo "- Notebook Step Outcome: ${{ steps.do_notebook.outcome }}"
            echo
            if [ "${{ steps.do_notebook.outcome }}" = "success" ]; then
              echo "## Check"
              echo "Notebook execution passed."
              echo
              echo "## Act"
              echo "No corrective action required."
            else
              echo "## Check"
              echo "Notebook execution failed."
              echo
              echo "## Act"
              echo "Failure issue will be created automatically."
            fi
          } > reports/pdca-report.md

      - name: Check - upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pdca-report
          path: reports/pdca-report.md

      - name: Act - create issue on failure
        if: steps.do_notebook.outcome == 'failure' && github.event_name != 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const title = `[PDCA][FAIL] Notebook test failed (${context.sha.substring(0, 7)})`;
            const body = [
              '# PDCA Auto Issue',
              '',
              '- Stage: Act',
              '- Result: Notebook execution failed',
              `- Commit: ${context.sha}`,
              `- Run: ${runUrl}`,
              '',
              'Please inspect the workflow logs and apply corrective changes.'
            ].join('\n');

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            const duplicate = issues.find(i => i.title === title);
            if (!duplicate) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['pdca', 'ci-failure']
              });
            }

      - name: Finalize - fail workflow when Do failed
        if: steps.do_notebook.outcome == 'failure'
        run: |
          echo "Notebook execution failed in Do stage."
          exit 1
